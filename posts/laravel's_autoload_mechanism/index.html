<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Laravel的类自动加载机制" /><meta name="author" content="chukeey" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="1. 背景 在PHP开发过程中，如果希望从外部引入一个class，通常会使用include和require方法，去把定义这个class的文件包含进来。" /><meta property="og:description" content="1. 背景 在PHP开发过程中，如果希望从外部引入一个class，通常会使用include和require方法，去把定义这个class的文件包含进来。" /><link rel="canonical" href="https://ccke.github.io/posts/laravel's_autoload_mechanism/" /><meta property="og:url" content="https://ccke.github.io/posts/laravel's_autoload_mechanism/" /><meta property="og:site_name" content="格物致知" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-04-10T16:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Laravel的类自动加载机制" /><meta name="twitter:site" content="@chukeey3" /><meta name="twitter:creator" content="@chukeey" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"chukeey"},"headline":"Laravel的类自动加载机制","dateModified":"2021-08-08T23:11:41+08:00","datePublished":"2021-04-10T16:00:00+08:00","description":"1. 背景 在PHP开发过程中，如果希望从外部引入一个class，通常会使用include和require方法，去把定义这个class的文件包含进来。","url":"https://ccke.github.io/posts/laravel's_autoload_mechanism/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://ccke.github.io/posts/laravel's_autoload_mechanism/"},"@context":"https://schema.org"}</script><title>Laravel的类自动加载机制 | 格物致知</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-SWM3EY2HK8"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-SWM3EY2HK8'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/favicons/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">格物致知</a></div><div class="site-subtitle font-italic">要专精，也要博广呀!</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>主页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>目录</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>关于我</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/ccke" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/chukeey3" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['chukeey.ke','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } updateCommentStyle() { var theme = "github-light"; if (this.modeStatus === ModeToggle.DARK_MODE) { theme = "github-dark"; } let comment = document.querySelector("iframe.utterances-frame"); if (comment == null) { return; } comment.contentWindow.postMessage( { type: "set-theme", theme: theme }, "https://utteranc.es/" ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); this.updateCommentStyle(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/">主页</a> </span> <span>Laravel的类自动加载机制</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="搜索..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Laravel的类自动加载机制</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> chukeey </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Apr 10, 2021, 4:00 PM +0800" prep="on" > Apr 10 <i class="unloaded">2021-04-10T16:00:00+08:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Aug 8, 2021, 11:11 PM +0800" prefix="Updated " > Aug 8 <i class="unloaded">2021-08-08T23:11:41+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="8250 words">45 min</span></div></div><div class="post-content"><h3 id="1-背景">1. 背景</h3><p>在PHP开发过程中，如果希望从外部引入一个class，通常会使用include和require方法，去把定义这个class的文件包含进来。</p><p>include 和 require 除了处理错误的方式不同之外，在其他方面都是相同的：</p><blockquote><ul><li>require 生成一个致命错误（E_COMPILE_ERROR），在错误发生后脚本会停止执行。<strong>（推荐使用）</strong><li>include 生成一个警告（E_WARNING），在错误发生后脚本会继续执行。</ul></blockquote><p>这个在小规模开发的时候，没什么大问题；但在大型的开发项目中，这么做会产生大量的require或者include方法调用，不仅降低效率，而且使得代码难以维护，况且require_once的代价很大。 在PHP5之前，各个PHP框架如果要实现类的自动加载，一般都是按照某种约定自己实现一个遍历目录，自动加载所有符合约定规则的文件的类或函数。 当然，PHP5之前对面向对象的支持并不是太好，类的使用也没有现在频繁。 在PHP5后，当加载PHP类时，如果类所在文件没有被包含进来，或者类名出错，Zend引擎会自动调用 <strong>__autoload函数</strong>。此函数需要用户自己实现 __autoload函数。 在PHP5.1.2版本后，可以使用<strong>spl_autoload_register函数</strong>自定义自动加载处理函数。当没有调用此函数，默认情况下会使用SPL自定义的<strong>spl_autoload函数</strong>。</p><h3 id="2-php自动加载">2. php自动加载</h3><h4 id="21-__autoload示例">2.1 __autoload示例：</h4><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="n">__autoload</span><span class="p">(</span><span class="nv">$className</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">'__autload class:'</span><span class="p">,</span> <span class="nv">$className</span><span class="p">,</span> <span class="kc">PHP_EOL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">new</span> <span class="nc">Demo</span><span class="p">();</span>

<span class="c1">// 输出：</span>
<span class="c1">// __autload class:Demo</span>
<span class="c1">// PHP Fatal error:  Uncaught Error: Class 'Demo' not found in XXX\test.php:8</span>
</pre></table></code></div></div><p>我们一般使用_autoload自动加载类如下：</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="n">__autoload</span><span class="p">(</span><span class="nv">$className</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">require_once</span> <span class="p">(</span><span class="nv">$className</span> <span class="mf">.</span> <span class="s1">'.class.php'</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">new</span> <span class="nc">Demo</span><span class="p">();</span>
</pre></table></code></div></div><p>我们可以看出_autoload至少要做三件事情：</p><blockquote><ul><li><p>第一件事是根据类名确定类文件名</p><li><p>第二件事是确定类文件所在的磁盘路径（在我们的例子是最简单的情况，类与调用它们的PHP程序文件在同一个文件夹下）</p><li><p>第三件事是将类从磁盘文件中加载到系统中</p></ul></blockquote><p>第三步最简单，只需要使用include/require即可。要实现第一步，第二步的功能，必须在开发时约定类名与磁盘文件的映射方法，只有这样我们才能根据类名找到它对应的磁盘文件。</p><p>因此，当有大量的类文件要包含的时候，我们只要确定相应的规则，然后在__autoload()函数中，将类名与实际的磁盘文件对应起来，就可以实现<strong>lazy loading</strong>的效果。从这里我们也可以看出__autoload()函数的实现中<strong>最重要的是类名与实际的磁盘文件映射规则的实现</strong>。</p><p>但现在问题来了，假如在一个系统的实现中，需要使用很多其它的类库，这些类库可能是由不同的开发工程师开发，其类名与实际的磁盘文件的映射规则不尽相同。这时假如要实现类库文件的自动加载，由于<strong>__autoload() 是全局函数只能定义一次，就必须在__autoload()函数中将所有的映射规则全部实现</strong>，因此该函数有可能会非常复杂，甚至无法实现，即便能够实现，也会给将来的维护和系统效率带来很大的负面影响。</p><p>在这种情况下，在PHP5引入SPL标准库，一种新的解决方案，使用一个 __autoload函数的队列 ，不同的映射关系写到不同的 __autoload函数中去，然后统一注册统一管理，即<strong>spl_autoload_register()函数</strong>。</p><h4 id="22-spl_autoload_register函数">2.2 spl_autoload_register()函数</h4><p>此函数的功能就是把函数注册至SPL的__autoload函数队列中，并会将Zend Engine中的<a href="https://www.php.net/manual/zh/function.autoload.php">__autoload()</a>函数取代为<a href="https://www.php.net/manual/zh/function.spl-autoload.php">spl_autoload()</a>或<a href="https://www.php.net/manual/zh/function.spl-autoload-call.php">spl_autoload_call()</a>。下面的例子可以看出：</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="n">__autoload</span><span class="p">(</span><span class="nv">$className</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">'__autoload class:'</span><span class="p">,</span> <span class="nv">$className</span><span class="p">,</span> <span class="kc">PHP_EOL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="n">classLoader</span><span class="p">(</span><span class="nv">$className</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">'SPL load class:'</span><span class="p">,</span> <span class="nv">$className</span><span class="p">,</span> <span class="kc">PHP_EOL</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb">spl_autoload_register</span><span class="p">(</span><span class="s1">'classLoader'</span><span class="p">);</span>

<span class="k">new</span> <span class="nc">Demo</span><span class="p">();</span>

<span class="c1">//结果：SPL load class:Demo</span>
</pre></table></code></div></div><blockquote><p>语法：bool spl_autoload_register ( [callback $autoload_function] ) 接受两个参数：一个是添加到自动加载栈的函数，另外一个是加载器不能找到这个类时是否抛出异常的标志。</p><p>第一个参数是可选的，并且默认指向spl_autoload()函数，这个函数会自动在路径中查找具有小写类名和.php扩展或者.ini扩展名，或者任何注册到spl_autoload_extensions()函数中的其它扩展名的文件。</p></blockquote><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">Test</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">loader</span><span class="p">(</span><span class="nv">$className</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$classFile</span> <span class="o">=</span> <span class="nb">strtolower</span><span class="p">(</span><span class="nv">$className</span><span class="p">)</span> <span class="mf">.</span> <span class="s2">".php"</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$classFile</span><span class="p">)){</span>
            <span class="k">require_once</span><span class="p">(</span><span class="nv">$classFile</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 方法为静态方法</span>
<span class="nb">spl_autoload_register</span><span class="p">(</span><span class="s1">'Test::loader'</span><span class="p">);</span>

<span class="k">new</span> <span class="nc">Demo</span><span class="p">();</span>
</pre></table></code></div></div><p>一旦调用spl_autoload_register()函数，当调用未定义类时，系统会按顺序调用注册到spl_autoload_register()函数的所有函数，而不是自动调用__autoload()函数。如果要避免这种情况，需采用一种更加安全的spl_autoload_register()函数的初始化调用方法：</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="kc">false</span> <span class="o">===</span> <span class="nb">spl_autoload_functions</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">function_exists</span><span class="p">(</span><span class="s1">'__autoload'</span><span class="p">))</span> <span class="p">{</span>
        <span class="nb">spl_autoload_register</span><span class="p">(</span><span class="s1">'__autoload'</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">}</span>
 <span class="p">}</span>
</pre></table></code></div></div><p><strong>spl_autoload_functions()函数会返回已注册函数的一个数组</strong>，如果SPL自动加载队列还没有被初始化，它会返回布尔值false。然后，检查是否有一个名为__autoload()的函数存在，如果存在，可以将它注册为自动加载队列中的第一个函数，从而保留它的功能。之后，可以继续注册自动加载函数。</p><p>还可以调用spl_autoload_register()函数以注册一个回调函数，而不是为函数提供一个字符串名称。如提供一个如<code class="language-plaintext highlighter-rouge">array('class', 'method')</code>这样的数组，使得可以使用某个对象的方法。</p><p>下一步，通过调用spl_autoload_call(‘className’)函数，可以手动调用加载器，而不用尝试去使用那个类。这个函数可以和函数class_exists(‘className’, false)组合在一起使用以尝试去加载一个类，并且在所有的自动加载器都不能找到那个类的情况下失败。</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="nb">spl_autoload_call</span><span class="p">(</span><span class="s1">'className'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">class_exists</span><span class="p">(</span><span class="s1">'className'</span><span class="p">,</span> <span class="kc">false</span><span class="p">))</span> <span class="p">{</span>

<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

<span class="p">}</span>
</pre></table></code></div></div><blockquote><p><strong>结语：</strong>SPL自动加载功能是由spl_autoload()，spl_autoload_register()，spl_autoload_functions()，spl_autoload_extensions()和spl_autoload_call()函数提供的。</p></blockquote><h3 id="3-composer自动加载">3. composer自动加载</h3><h4 id="31-psr规范">3.1 PSR规范</h4><p>与php自动加载相关的规范是 PSR4，在说 PSR4 之前先介绍一下 PSR 标准。</p><blockquote><p>PSR 标准的发明和推出组织是：PHP-FIG，它的网站是：www.php-fig.org。由几位开源框架的开发者成立于 2009 年，从那开始也选取了很多其他成员进来，虽然不是 “官方” 组织，但也代表了社区中不小的一块。组织的目的在于：以最低程度的限制，来统一各个项目的编码规范，避免各家自行发展的风格阻碍了程序员开发的困扰，于是大伙发明和总结了 PSR，PSR 是 PHP Standards Recommendation 的缩写。</p></blockquote><p>截止到目前为止，总共有 14 套 PSR 规范，其中有 7 套PSR规范已通过表决并推出使用，分别是：</p><ul><li><strong>PSR-0 自动加载标准</strong>（已废弃，一些旧的第三方库还有在使用） PSR-1 基础编码标准<li><p>PSR-2 编码风格向导</p><li><p>PSR-3 日志接口</p><li><p><strong>PSR-4 自动加载的增强版</strong>，替换掉了 PSR-0</p><li><p>PSR-6 缓存接口规范</p><li>PSR-7 HTTP 消息接口规范</ul><h4 id="32-psr4-标准">3.2 PSR4 标准</h4><p>2013 年底，PHP-FIG 推出了第 5 个规范——PSR-4。</p><p>PSR-4 规范了如何指定文件路径从而自动加载类定义，同时规范了自动加载文件的位置。</p><blockquote><p>1）一个完整的类名需具有以下结构： &lt;命名空间&gt;&lt;子命名空间&gt;&lt;类名&gt;</p><ul><li>完整的类名必须要有一个顶级命名空间，被称为 “vendor namespace”；<li>完整的类名可以有一个或多个子命名空间；<li>完整的类名必须有一个最终的类名；<li>完整的类名中任意一部分中的下滑线都是没有特殊含义的；<li>完整的类名可以由任意大小写字母组成；<li>所有类名都必须是大小写敏感的。</ul><p>2）根据完整的类名载入相应的文件</p><ul><li><p>完整的类名中，去掉最前面的命名空间分隔符，前面连续的一个或多个命名空间和子命名空间，作为「命名空间前缀」，其必须与至少一个「文件基目录」相对应；</p><li><p>紧接命名空间前缀后的子命名空间 必须 与相应的「文件基目录」相匹配，其中的命名空间分隔符将作为目录分隔符；</p><li><p>末尾的类名必须与对应的以 .php 为后缀的文件同名；</p><li><p>自动加载器（autoloader）的实现一定不可抛出异常、一定不可触发任一级别的错误信息以及不应该有返回值。</p></ul><p>3) 例子 PSR-4风格：</p><ul><li>类名：SymfonyCoreRequest<li>命名空间前缀：SymfonyCore<li>文件基目录：./vendor/Symfony/Core/<li>文件路径：./vendor/Symfony/Core/Request.php</ul><p>目录结构：</p><p>-vendor/</p><div class="table-wrapper"><table><tbody><tr><td>-vendor_name/</table></div><div class="table-wrapper"><table><tbody><tr><td> <td>-package_name/</table></div><div class="table-wrapper"><table><tbody><tr><td> <td> <td>-src/</table></div><div class="table-wrapper"><table><tbody><tr><td> <td> <td> <td>-ClassName.php # Vendor_Name\Package_Name\ClassName</table></div><div class="table-wrapper"><table><tbody><tr><td> <td> <td>-tests/</table></div><div class="table-wrapper"><table><tbody><tr><td> <td> <td> <td>-ClassNameTest.php # Vendor_Name\Package_Name\ClassNameTest</table></div></blockquote><h4 id="33-composer依赖管理">3.3 Composer依赖管理</h4><p>Composer 不是一个包管理器。是的，它涉及 “packages” 和 “libraries”，但它在每个项目的基础上进行管理，在你项目的某个目录中（例如 <code class="language-plaintext highlighter-rouge">vendor</code>）进行安装。默认情况下它不会在全局安装任何东西。因此，这<strong>仅仅是一个依赖管理</strong>。</p><p>这种想法并不新鲜，Composer 受到了 node’s npm 和 ruby’s bundler 的强烈启发。而当时 PHP 下并没有类似的工具。</p><p><strong>Composer 将这样为你解决问题：</strong></p><p>a) 你有一个项目依赖于若干个库。</p><p>b) 其中一些库依赖于其他库。</p><p>c) 你声明你所依赖的东西。</p><p>d) Composer 会找出哪个版本的包需要安装，并安装它们（将它们下载到你的项目中）。</p><p><strong>声明依赖关系</strong></p><p>比方说，你正在创建一个项目，你需要一个库来做日志记录。你决定使用 monolog。为了将它添加到你的项目中，你所需要做的就是创建一个 composer.json 文件，其中描述了项目的依赖关系。</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="p">{</span>
    <span class="s2">"require"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"monolog/monolog"</span><span class="o">:</span> <span class="s2">"1.2.*"</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>我们只要指出我们的项目需要一些 monolog/monolog 的包，从 1.2 开始的任何版本。</p><blockquote><p>简单的说，Composer 帮我们做了这些事：</p><ul><li><p>下载好了符合 PSR0/PSR4标准 的第三方库，并把文件放在相应位置（vendor 目录下）；</p><li><p>写了 __autoload() 函数，注册到了 spl_register() 函数，当我们想用第三方库的时候直接使用命名空间即可。</p></ul><p><strong>那么当我们想要写自己的命名空间的时候，该怎么办呢？</strong></p><p>1）按照 PSR4标准 命名我们的命名空间，放置我们的文件；</p><p>2）在 composer 里面写好顶级域名与具体目录的映射，就可以享用 composer 的便利了。</p><p>当然如果有一个非常棒的框架，我们会惊喜地发现，在 composer 里面写顶级域名映射这事我们也不用做了，框架已经帮我们写好了顶级域名映射了，我们只需要在框架里面新建文件，在新建的文件中写好命名空间，就可以在任何地方 use 我们的命名空间了。</p></blockquote><h4 id="34-composer自动加载">3.4 Composer自动加载</h4><p>首先，我们先大致了解一下Composer自动加载所用到的源文件：</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="n">autoload_real</span><span class="mf">.</span><span class="n">php</span><span class="o">:</span> <span class="n">自动加载功能的引导类</span>
<span class="c1">// 任务是composer加载类的初始化（顶级命名空间与文件路径映射初始化）和注册（spl_autoload_register()）</span>

<span class="nc">ClassLoader</span><span class="mf">.</span><span class="n">php</span><span class="o">:</span> <span class="n">composer加载类</span>
<span class="c1">// composer自动加载功能的核心类</span>

<span class="n">autoload_static</span><span class="mf">.</span><span class="n">php</span><span class="o">:</span> <span class="n">顶级命名空间初始化类</span>
<span class="c1">// 用于给核心类初始化顶级命名空间</span>

<span class="n">autoload_classmap</span><span class="mf">.</span><span class="n">php</span><span class="o">:</span> <span class="n">自动加载的最简单形式</span>
<span class="c1">// 有完整的命名空间和文件目录的映射</span>

<span class="n">autoload_files</span><span class="mf">.</span><span class="n">php</span><span class="o">:</span> <span class="n">用于加载全局函数的文件</span>
<span class="c1">// 存放各个全局函数所在的文件路径名</span>

<span class="n">autoload_namespaces</span><span class="mf">.</span><span class="n">php</span><span class="o">:</span> <span class="n">符合PSR0标准的自动加载文件</span>
<span class="c1">// 存放着顶级命名空间与文件的映射</span>

<span class="n">autoload_psr4</span><span class="mf">.</span><span class="n">php</span><span class="o">:</span> <span class="n">符合PSR4标准的自动加载文件</span>
<span class="c1">// 存放着顶级命名空间与文件的映射</span>
</pre></table></code></div></div><h5 id="341-autoload_realphp-引导类">3.4.1 autoload_real.php 引导类</h5><p>在 vendor 目录下的 autoload.php 文件中我们可以看出，程序主要调用了引导类的静态方法 getLoader() 来达到自动加载的目的，我们接着看看这个函数：</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre><td class="rouge-code"><pre><span class="cd">/**
 * @return \Composer\Autoload\ClassLoader
 */</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">getLoader</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// 经典单例模式</span>
    <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">!==</span> <span class="k">self</span><span class="o">::</span><span class="nv">$loader</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">::</span><span class="nv">$loader</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 平台检查：当前composer版本需要PHP版本 &gt;= 7.2.5</span>
    <span class="k">require</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/platform_check.php'</span><span class="p">;</span>

    <span class="c1">// 获得自动加载核心类对象</span>
    <span class="nb">spl_autoload_register</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'ComposerAutoloaderInit59119be9e78c643dbb9f5087be96e6d6'</span><span class="p">,</span> <span class="s1">'loadClassLoader'</span><span class="p">),</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="k">self</span><span class="o">::</span><span class="nv">$loader</span> <span class="o">=</span> <span class="nv">$loader</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">Composer\Autoload\ClassLoader</span><span class="p">(</span><span class="err">\</span><span class="nb">dirname</span><span class="p">(</span><span class="err">\</span><span class="nb">dirname</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">)));</span>
    <span class="nb">spl_autoload_unregister</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'ComposerAutoloaderInit59119be9e78c643dbb9f5087be96e6d6'</span><span class="p">,</span> <span class="s1">'loadClassLoader'</span><span class="p">));</span>

    <span class="c1">// 初始化自动加载核心类对象</span>
    <span class="nv">$useStaticLoader</span> <span class="o">=</span> <span class="kc">PHP_VERSION_ID</span> <span class="o">&gt;=</span> <span class="mi">50600</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="s1">'HHVM_VERSION'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nb">function_exists</span><span class="p">(</span><span class="s1">'zend_loader_file_encoded'</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nf">zend_loader_file_encoded</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$useStaticLoader</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">require</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/autoload_static.php'</span><span class="p">;</span>

        <span class="nb">call_user_func</span><span class="p">(</span><span class="err">\</span><span class="nc">Composer\Autoload\ComposerStaticInit59119be9e78c643dbb9f5087be96e6d6</span><span class="o">::</span><span class="nf">getInitializer</span><span class="p">(</span><span class="nv">$loader</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$map</span> <span class="o">=</span> <span class="k">require</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/autoload_namespaces.php'</span><span class="p">;</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$map</span> <span class="k">as</span> <span class="nv">$namespace</span> <span class="o">=&gt;</span> <span class="nv">$path</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$loader</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="nv">$namespace</span><span class="p">,</span> <span class="nv">$path</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$map</span> <span class="o">=</span> <span class="k">require</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/autoload_psr4.php'</span><span class="p">;</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$map</span> <span class="k">as</span> <span class="nv">$namespace</span> <span class="o">=&gt;</span> <span class="nv">$path</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$loader</span><span class="o">-&gt;</span><span class="nf">setPsr4</span><span class="p">(</span><span class="nv">$namespace</span><span class="p">,</span> <span class="nv">$path</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$classMap</span> <span class="o">=</span> <span class="k">require</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/autoload_classmap.php'</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$classMap</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$loader</span><span class="o">-&gt;</span><span class="nf">addClassMap</span><span class="p">(</span><span class="nv">$classMap</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 注册自动加载核心类对象</span>
    <span class="nv">$loader</span><span class="o">-&gt;</span><span class="nf">register</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

    <span class="c1">// 自动加载全局函数</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$useStaticLoader</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$includeFiles</span> <span class="o">=</span> <span class="nc">Composer\Autoload\ComposerStaticInit59119be9e78c643dbb9f5087be96e6d6</span><span class="o">::</span><span class="nv">$files</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$includeFiles</span> <span class="o">=</span> <span class="k">require</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/autoload_files.php'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$includeFiles</span> <span class="k">as</span> <span class="nv">$fileIdentifier</span> <span class="o">=&gt;</span> <span class="nv">$file</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">composerRequire59119be9e78c643dbb9f5087be96e6d6</span><span class="p">(</span><span class="nv">$fileIdentifier</span><span class="p">,</span> <span class="nv">$file</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">$loader</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>从上面可以看出，我们可以把自动加载引导类分为6步：</p><p><strong>1）经典单例模式</strong></p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">!==</span> <span class="k">self</span><span class="o">::</span><span class="nv">$loader</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="k">self</span><span class="o">::</span><span class="nv">$loader</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>2）平台检查</strong></p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="c1">// platform_check.php @generated by Composer</span>

<span class="nv">$issues</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="kc">PHP_VERSION_ID</span> <span class="o">&gt;=</span> <span class="mi">70205</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$issues</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'Your Composer dependencies require a PHP version "&gt;= 7.2.5". You are running '</span> <span class="mf">.</span> <span class="kc">PHP_VERSION</span> <span class="mf">.</span> <span class="s1">'.'</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$issues</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">headers_sent</span><span class="p">())</span> <span class="p">{</span>
        <span class="nb">header</span><span class="p">(</span><span class="s1">'HTTP/1.1 500 Internal Server Error'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">ini_get</span><span class="p">(</span><span class="s1">'display_errors'</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="kc">PHP_SAPI</span> <span class="o">===</span> <span class="s1">'cli'</span> <span class="o">||</span> <span class="kc">PHP_SAPI</span> <span class="o">===</span> <span class="s1">'phpdbg'</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">fwrite</span><span class="p">(</span><span class="no">STDERR</span><span class="p">,</span> <span class="s1">'Composer detected issues in your platform:'</span> <span class="mf">.</span> <span class="kc">PHP_EOL</span><span class="mf">.</span><span class="kc">PHP_EOL</span> <span class="mf">.</span> <span class="nb">implode</span><span class="p">(</span><span class="kc">PHP_EOL</span><span class="p">,</span> <span class="nv">$issues</span><span class="p">)</span> <span class="mf">.</span> <span class="kc">PHP_EOL</span><span class="mf">.</span><span class="kc">PHP_EOL</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="nb">headers_sent</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="s1">'Composer detected issues in your platform:'</span> <span class="mf">.</span> <span class="kc">PHP_EOL</span><span class="mf">.</span><span class="kc">PHP_EOL</span> <span class="mf">.</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">'You are running '</span><span class="mf">.</span><span class="kc">PHP_VERSION</span><span class="mf">.</span><span class="s1">'.'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nb">implode</span><span class="p">(</span><span class="kc">PHP_EOL</span><span class="p">,</span> <span class="nv">$issues</span><span class="p">))</span> <span class="mf">.</span> <span class="kc">PHP_EOL</span><span class="mf">.</span><span class="kc">PHP_EOL</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nb">trigger_error</span><span class="p">(</span>
        <span class="s1">'Composer detected issues in your platform: '</span> <span class="mf">.</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span> <span class="nv">$issues</span><span class="p">),</span>
        <span class="kc">E_USER_ERROR</span>
    <span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>3）构造ClassLoader核心类</strong></p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">spl_autoload_register</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'ComposerAutoloaderInit59119be9e78c643dbb9f5087be96e6d6'</span><span class="p">,</span> <span class="s1">'loadClassLoader'</span><span class="p">),</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="k">self</span><span class="o">::</span><span class="nv">$loader</span> <span class="o">=</span> <span class="nv">$loader</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">Composer\Autoload\ClassLoader</span><span class="p">(</span><span class="err">\</span><span class="nb">dirname</span><span class="p">(</span><span class="err">\</span><span class="nb">dirname</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">)));</span>
    <span class="nb">spl_autoload_unregister</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'ComposerAutoloaderInit59119be9e78c643dbb9f5087be96e6d6'</span><span class="p">,</span> <span class="s1">'loadClassLoader'</span><span class="p">)</span>
</pre></table></code></div></div><p>loadClassLoader()函数：</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">loadClassLoader</span><span class="p">(</span><span class="nv">$class</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="s1">'Composer\Autoload\ClassLoader'</span> <span class="o">===</span> <span class="nv">$class</span><span class="p">)</span> <span class="p">{</span>
    	<span class="k">require</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/ClassLoader.php'</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>从程序里面我们可以看出，composer 先向 PHP 自动加载机制注册了一个函数，这个函数 require 了 ClassLoader 文件。成功 new 出该文件中核心类 ClassLoader() 后，又销毁了该函数。</p><blockquote><p><strong>为什么不直接require，而要这么麻烦？</strong></p><p>原因就是怕有的用户也定义了个 \Composer\Autoload\ClassLoader 命名空间，导致自动加载错误文件。那为什么不跟引导类一样用个 hash 呢？因为这个类是可以复用的，框架允许用户使用这个类。</p></blockquote><p><strong>4）初始化核心类对象</strong></p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="nv">$useStaticLoader</span> <span class="o">=</span> <span class="kc">PHP_VERSION_ID</span> <span class="o">&gt;=</span> <span class="mi">50600</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="s1">'HHVM_VERSION'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nb">function_exists</span><span class="p">(</span><span class="s1">'zend_loader_file_encoded'</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nf">zend_loader_file_encoded</span><span class="p">());</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$useStaticLoader</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">require</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/autoload_static.php'</span><span class="p">;</span>

    <span class="nb">call_user_func</span><span class="p">(</span><span class="err">\</span><span class="nc">Composer\Autoload\ComposerStaticInit59119be9e78c643dbb9f5087be96e6d6</span><span class="o">::</span><span class="nf">getInitializer</span><span class="p">(</span><span class="nv">$loader</span><span class="p">));</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$map</span> <span class="o">=</span> <span class="k">require</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/autoload_namespaces.php'</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$map</span> <span class="k">as</span> <span class="nv">$namespace</span> <span class="o">=&gt;</span> <span class="nv">$path</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$loader</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="nv">$namespace</span><span class="p">,</span> <span class="nv">$path</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nv">$map</span> <span class="o">=</span> <span class="k">require</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/autoload_psr4.php'</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$map</span> <span class="k">as</span> <span class="nv">$namespace</span> <span class="o">=&gt;</span> <span class="nv">$path</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$loader</span><span class="o">-&gt;</span><span class="nf">setPsr4</span><span class="p">(</span><span class="nv">$namespace</span><span class="p">,</span> <span class="nv">$path</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nv">$classMap</span> <span class="o">=</span> <span class="k">require</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/autoload_classmap.php'</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$classMap</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$loader</span><span class="o">-&gt;</span><span class="nf">addClassMap</span><span class="p">(</span><span class="nv">$classMap</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>这一部分就是对自动加载类的初始化，主要是给自动加载核心类初始化顶级命名空间映射。</p><blockquote><p>初始化的方法有两种：</p><ul><li>使用autoload_static进行静态初始化；<li>调用核心类接口初始化。</ul></blockquote><p><strong>a. 使用autoload_static进行静态初始化 ( PHP &gt;= 5.6 ，并且不支持 HHVM 虚拟机)</strong></p><p>我们深入 autoload_static.php 这个文件发现这个文件定义了一个用于静态初始化的类，名字叫 ComposerStaticInit59119be9e78c643dbb9f5087be96e6d6，仍然为了避免冲突加了 hash 值。这个类很简单：</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="c1">// autoload_static.php @generated by Composer</span>

<span class="kn">namespace</span> <span class="nn">Composer\Autoload</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">ComposerStaticInit59119be9e78c643dbb9f5087be96e6d6</span>
<span class="p">{</span>
     <span class="k">public</span> <span class="k">static</span> <span class="nv">$files</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="mf">...</span><span class="p">);</span>
     <span class="k">public</span> <span class="k">static</span> <span class="nv">$prefixLengthsPsr4</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="mf">...</span><span class="p">);</span>
     <span class="k">public</span> <span class="k">static</span> <span class="nv">$prefixDirsPsr4</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="mf">...</span><span class="p">);</span>
     <span class="k">public</span> <span class="k">static</span> <span class="nv">$prefixesPsr0</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="mf">...</span><span class="p">);</span>
     <span class="k">public</span> <span class="k">static</span> <span class="nv">$classMap</span> <span class="o">=</span> <span class="k">array</span> <span class="p">(</span><span class="mf">...</span><span class="p">);</span>

	<span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">getInitializer</span><span class="p">(</span><span class="kt">ClassLoader</span> <span class="nv">$loader</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="err">\</span><span class="nc">Closure</span><span class="o">::</span><span class="nf">bind</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$loader</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$loader</span><span class="o">-&gt;</span><span class="n">prefixLengthsPsr4</span> <span class="o">=</span> <span class="nc">ComposerStaticInit59119be9e78c643dbb9f5087be96e6d6</span><span class="o">::</span><span class="nv">$prefixLengthsPsr4</span><span class="p">;</span>
            <span class="nv">$loader</span><span class="o">-&gt;</span><span class="n">prefixDirsPsr4</span> <span class="o">=</span> <span class="nc">ComposerStaticInit59119be9e78c643dbb9f5087be96e6d6</span><span class="o">::</span><span class="nv">$prefixDirsPsr4</span><span class="p">;</span>
            <span class="nv">$loader</span><span class="o">-&gt;</span><span class="n">prefixesPsr0</span> <span class="o">=</span> <span class="nc">ComposerStaticInit59119be9e78c643dbb9f5087be96e6d6</span><span class="o">::</span><span class="nv">$prefixesPsr0</span><span class="p">;</span>
            <span class="nv">$loader</span><span class="o">-&gt;</span><span class="n">classMap</span> <span class="o">=</span> <span class="nc">ComposerStaticInit59119be9e78c643dbb9f5087be96e6d6</span><span class="o">::</span><span class="nv">$classMap</span><span class="p">;</span>

        <span class="p">},</span> <span class="kc">null</span><span class="p">,</span> <span class="nc">ClassLoader</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>这个静态初始化类的核心就是 getInitializer() 函数，它将自己类中的顶级命名空间映射给了 ClassLoader类。值得注意的是这个函数返回的是一个匿名函数，为什么呢？<strong>原因就是 ClassLoader类 中的 prefixLengthsPsr4 、prefixDirsPsr4等等方法都是private的。</strong>普通的函数没办法给类的 private 成员变量赋值。<strong>利用匿名函数的绑定功能就可以将把匿名函数转为 ClassLoader类 的成员函数</strong>。</p><blockquote><p>关于匿名函数的绑定功能见：https://www.php.net/manual/zh/closure.bind.php</p></blockquote><p>可以看到顶级命名空间初始化的关键是：$prefixLengthsPsr4、$prefixDirsPsr4、$prefixesPsr0、$classMap，接下来我们分别看下这些文件：</p><p><strong>PSR0 顶级命名空间映射：</strong></p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
	<span class="k">public</span> <span class="k">static</span> <span class="nv">$prefixesPsr0</span> <span class="o">=</span> <span class="k">array</span> <span class="p">(</span>
        <span class="s1">'M'</span> <span class="o">=&gt;</span>
        <span class="k">array</span> <span class="p">(</span>
            <span class="s1">'Mockery'</span> <span class="o">=&gt;</span>
            <span class="k">array</span> <span class="p">(</span>
                <span class="mi">0</span> <span class="o">=&gt;</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/..'</span> <span class="mf">.</span> <span class="s1">'/mockery/mockery/library'</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s1">'H'</span> <span class="o">=&gt;</span>
        <span class="k">array</span> <span class="p">(</span>
            <span class="s1">'Highlight\\'</span> <span class="o">=&gt;</span>
            <span class="k">array</span> <span class="p">(</span>
                <span class="mi">0</span> <span class="o">=&gt;</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/..'</span> <span class="mf">.</span> <span class="s1">'/scrivo/highlight.php'</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="s1">'HighlightUtilities\\'</span> <span class="o">=&gt;</span>
            <span class="k">array</span> <span class="p">(</span>
                <span class="mi">0</span> <span class="o">=&gt;</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/..'</span> <span class="mf">.</span> <span class="s1">'/scrivo/highlight.php'</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">);</span>
</pre></table></code></div></div><p>为了快速找到顶级命名空间，我们这里使用命名空间第一个字母作为前缀索引。这个映射的用法比较明显，假如我们有Highlight/Language 这样的命名空间，首先通过首字母H，找到如下数组：</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
  	<span class="s1">'H'</span> <span class="o">=&gt;</span>
        <span class="k">array</span> <span class="p">(</span>
            <span class="s1">'Highlight\\'</span> <span class="o">=&gt;</span>
            <span class="k">array</span> <span class="p">(</span>
                <span class="mi">0</span> <span class="o">=&gt;</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/..'</span> <span class="mf">.</span> <span class="s1">'/scrivo/highlight.php'</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="s1">'HighlightUtilities\\'</span> <span class="o">=&gt;</span>
            <span class="k">array</span> <span class="p">(</span>
                <span class="mi">0</span> <span class="o">=&gt;</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/..'</span> <span class="mf">.</span> <span class="s1">'/scrivo/highlight.php'</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
</pre></table></code></div></div><p>然后我们就会遍历这个数组来和 Highlight/Language 比较，发现第2个 HighlightUtilities 不符合，第1个 Highlight 符合，然后得到了映射目录（映射目录可能不止一个）：</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
    <span class="k">array</span> <span class="p">(</span><span class="mi">0</span> <span class="o">=&gt;</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/..'</span> <span class="mf">.</span> <span class="s1">'/scrivo/highlight.php'</span><span class="p">,),</span>
</pre></table></code></div></div><p>我们会接着遍历这个数组，尝试 <code class="language-plaintext highlighter-rouge">__DIR__ . '/..' . '/scrivo/highlight.php'</code>是否存在，如果不存在接着遍历数组（这个例子数组只有一个元素），如果数组遍历完都没有，就会加载失败。</p><p><strong>PSR4标准顶级命名空间映射数组：</strong></p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
  <span class="k">public</span> <span class="k">static</span> <span class="nv">$prefixLengthsPsr4</span> <span class="o">=</span> <span class="k">array</span> <span class="p">(</span>
        <span class="s1">'v'</span> <span class="o">=&gt;</span>
        <span class="k">array</span> <span class="p">(</span>
            <span class="s1">'voku\\'</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s1">'p'</span> <span class="o">=&gt;</span>
        <span class="k">array</span> <span class="p">(</span>
            <span class="s1">'phpDocumentor\\Reflection\\'</span> <span class="o">=&gt;</span> <span class="mi">25</span><span class="p">,</span>
        <span class="p">),</span>
  <span class="mf">...</span><span class="p">);</span>

  <span class="k">public</span> <span class="k">static</span> <span class="nv">$prefixDirsPsr4</span> <span class="o">=</span> <span class="k">array</span> <span class="p">(</span>
        <span class="s1">'voku\\'</span> <span class="o">=&gt;</span>
        <span class="k">array</span> <span class="p">(</span>
            <span class="mi">0</span> <span class="o">=&gt;</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/..'</span> <span class="mf">.</span> <span class="s1">'/voku/portable-ascii/src/voku'</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s1">'phpDocumentor\\Reflection\\'</span> <span class="o">=&gt;</span>
        <span class="k">array</span> <span class="p">(</span>
            <span class="mi">0</span> <span class="o">=&gt;</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/..'</span> <span class="mf">.</span> <span class="s1">'/phpdocumentor/reflection-common/src'</span><span class="p">,</span>
            <span class="mi">1</span> <span class="o">=&gt;</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/..'</span> <span class="mf">.</span> <span class="s1">'/phpdocumentor/type-resolver/src'</span><span class="p">,</span>
            <span class="mi">2</span> <span class="o">=&gt;</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/..'</span> <span class="mf">.</span> <span class="s1">'/phpdocumentor/reflection-docblock/src'</span><span class="p">,</span>
        <span class="p">),</span>
  <span class="mf">...</span><span class="p">);</span>
</pre></table></code></div></div><p>PSR4 标准顶级命名空间映射用了两个数组，第一个和 PSR0 一样用命名空间第一个字母作为前缀索引，然后是 顶级命名空间，但是最终并不是文件路径，而是 顶级命名空间的长度。为什么呢？<strong>因为 PSR4 标准是用顶级命名空间目录替换顶级命名空间，所以获得顶级命名空间的长度很重要</strong>。</p><p>PSR0中顶级命名空间目录直接加到命名空间前面就可以得到路径：</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nc">Highlight</span><span class="o">/</span><span class="nc">Language</span> <span class="o">=&gt;</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/..'</span> <span class="mf">.</span> <span class="s1">'/scrivo/highlight.php/Highlight/Language.php'</span>
</pre></table></code></div></div><p>而 PSR4标准却是用顶级命名空间目录替换顶级命名空间，得到路径：</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">phpDocumentor</span><span class="o">/</span><span class="nc">Reflection</span><span class="o">/</span><span class="nc">Element</span> <span class="o">=&gt;</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/..'</span> <span class="mf">.</span> <span class="s1">'/phpdocumentor/reflection-common/src/Element.php'</span>
</pre></table></code></div></div><p>具体的用法：假如我们找 phpDocumentor/Reflection/Element 这个命名空间，和 PSR0 一样通过前缀索引和字符串匹配我们得到了</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
	<span class="s1">'p'</span> <span class="o">=&gt;</span>
        <span class="k">array</span> <span class="p">(</span>
            <span class="s1">'phpDocumentor\\Reflection\\'</span> <span class="o">=&gt;</span> <span class="mi">25</span><span class="p">,</span>
        <span class="p">),</span>
</pre></table></code></div></div><p>这条记录，键是顶级命名空间，值是命名空间的长度。拿到顶级命名空间后去 $prefixDirsPsr4数组 获取它的映射目录数组：</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
	<span class="s1">'phpDocumentor\\Reflection\\'</span> <span class="o">=&gt;</span>
        <span class="k">array</span> <span class="p">(</span>
            <span class="mi">0</span> <span class="o">=&gt;</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/..'</span> <span class="mf">.</span> <span class="s1">'/phpdocumentor/reflection-common/src'</span><span class="p">,</span>
            <span class="mi">1</span> <span class="o">=&gt;</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/..'</span> <span class="mf">.</span> <span class="s1">'/phpdocumentor/type-resolver/src'</span><span class="p">,</span>
            <span class="mi">2</span> <span class="o">=&gt;</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/..'</span> <span class="mf">.</span> <span class="s1">'/phpdocumentor/reflection-docblock/src'</span><span class="p">,</span>
        <span class="p">),</span>
</pre></table></code></div></div><p>然后我们就可以将命名空间 phpDocumentor/Reflection/Element 前26个字符替换成目录 <code class="language-plaintext highlighter-rouge">__DIR__ . '/..' . '/phpdocumentor/reflection-common/src'</code> ，我们就得到了<code class="language-plaintext highlighter-rouge">__DIR__ . '/..' . '/phpdocumentor/reflection-common/src/Element.php'</code>，先验证磁盘上这个文件是否存在，如果不存在接着遍历。如果遍历后没有找到，则加载失败。</p><p><strong>最简单的 classMap:</strong></p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
  <span class="k">public</span> <span class="k">static</span> <span class="nv">$classMap</span> <span class="o">=</span> <span class="k">array</span> <span class="p">(</span>
        <span class="s1">'App\\Console\\Kernel'</span> <span class="o">=&gt;</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/../..'</span> <span class="mf">.</span> <span class="s1">'/app/Console/Kernel.php'</span><span class="p">,</span>
        <span class="s1">'App\\Exceptions\\Handler'</span> <span class="o">=&gt;</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/../..'</span> <span class="mf">.</span> <span class="s1">'/app/Exceptions/Handler.php'</span><span class="p">,</span>
        <span class="s1">'App\\Http\\Controllers\\Controller'</span> <span class="o">=&gt;</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/../..'</span> <span class="mf">.</span> <span class="s1">'/app/Http/Controllers/Controller.php'</span><span class="p">,</span>
  <span class="mf">...</span><span class="p">);</span>
</pre></table></code></div></div><p>直接命名空间全名与目录的映射，没有顶级命名空间，Laravel框架的app目录下的代码命名空间映射就放在这里。</p><p><strong>b. 调用核心类接口初始化</strong></p><p>如果PHP版本低于5.6或者使用 HHVM 虚拟机环境，那么就要使用核心类的接口进行初始化。</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
    <span class="c1">// PSR0标准</span>
    <span class="nv">$map</span> <span class="o">=</span> <span class="k">require</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/autoload_namespaces.php'</span><span class="p">;</span>
	<span class="k">foreach</span> <span class="p">(</span><span class="nv">$map</span> <span class="k">as</span> <span class="nv">$namespace</span> <span class="o">=&gt;</span> <span class="nv">$path</span><span class="p">)</span> <span class="p">{</span>
    	<span class="nv">$loader</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="nv">$namespace</span><span class="p">,</span> <span class="nv">$path</span><span class="p">);</span>
	<span class="p">}</span>

    <span class="c1">// PSR4标准</span>
	<span class="nv">$map</span> <span class="o">=</span> <span class="k">require</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/autoload_psr4.php'</span><span class="p">;</span>
	<span class="k">foreach</span> <span class="p">(</span><span class="nv">$map</span> <span class="k">as</span> <span class="nv">$namespace</span> <span class="o">=&gt;</span> <span class="nv">$path</span><span class="p">)</span> <span class="p">{</span>
    	<span class="nv">$loader</span><span class="o">-&gt;</span><span class="nf">setPsr4</span><span class="p">(</span><span class="nv">$namespace</span><span class="p">,</span> <span class="nv">$path</span><span class="p">);</span>
	<span class="p">}</span>

    <span class="c1">// 直接映射</span>
	<span class="nv">$classMap</span> <span class="o">=</span> <span class="k">require</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/autoload_classmap.php'</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$classMap</span><span class="p">)</span> <span class="p">{</span>
    	<span class="nv">$loader</span><span class="o">-&gt;</span><span class="nf">addClassMap</span><span class="p">(</span><span class="nv">$classMap</span><span class="p">);</span>
	<span class="p">}</span>
</pre></table></code></div></div><p><strong>PSR0标准</strong></p><p>autoload_namespaces.php</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="c1">// autoload_namespaces.php @generated by Composer</span>

<span class="nv">$vendorDir</span> <span class="o">=</span> <span class="nb">dirname</span><span class="p">(</span><span class="nb">dirname</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">));</span>
<span class="nv">$baseDir</span> <span class="o">=</span> <span class="nb">dirname</span><span class="p">(</span><span class="nv">$vendorDir</span><span class="p">);</span>

<span class="k">return</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'Mockery'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="nv">$vendorDir</span> <span class="mf">.</span> <span class="s1">'/mockery/mockery/library'</span><span class="p">),</span>
    <span class="s1">'Highlight\\'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="nv">$vendorDir</span> <span class="mf">.</span> <span class="s1">'/scrivo/highlight.php'</span><span class="p">),</span>
    <span class="s1">'HighlightUtilities\\'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="nv">$vendorDir</span> <span class="mf">.</span> <span class="s1">'/scrivo/highlight.php'</span><span class="p">),</span>
<span class="p">);</span>
</pre></table></code></div></div><p>PSR0标准的初始化接口：</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

	<span class="cd">/**
     * Registers a set of PSR-0 directories for a given prefix,
     * replacing any others previously set for this prefix.
     *
     * @param string       $prefix The prefix
     * @param array|string $paths  The PSR-0 base directories
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">set</span><span class="p">(</span><span class="nv">$prefix</span><span class="p">,</span> <span class="nv">$paths</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$prefix</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">fallbackDirsPsr0</span> <span class="o">=</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span> <span class="nv">$paths</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">prefixesPsr0</span><span class="p">[</span><span class="nv">$prefix</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="nv">$prefix</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span> <span class="nv">$paths</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>很简单，转换后的结构同 autoload_static.php 的 $prefixesPsr0 。如果没有顶级命名空间，就只存储一个路径名，以便在后面尝试加载。</p><p><strong>PSR4标准</strong></p><p>autoload_psr4.php</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="c1">// autoload_psr4.php @generated by Composer</span>

<span class="nv">$vendorDir</span> <span class="o">=</span> <span class="nb">dirname</span><span class="p">(</span><span class="nb">dirname</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">));</span>
<span class="nv">$baseDir</span> <span class="o">=</span> <span class="nb">dirname</span><span class="p">(</span><span class="nv">$vendorDir</span><span class="p">);</span>

<span class="k">return</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'voku\\'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="nv">$vendorDir</span> <span class="mf">.</span> <span class="s1">'/voku/portable-ascii/src/voku'</span><span class="p">),</span>
    <span class="s1">'phpDocumentor\\Reflection\\'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="nv">$vendorDir</span> <span class="mf">.</span> <span class="s1">'/phpdocumentor/reflection-common/src'</span><span class="p">,</span> <span class="nv">$vendorDir</span> <span class="mf">.</span> <span class="s1">'/phpdocumentor/type-resolver/src'</span><span class="p">,</span> <span class="nv">$vendorDir</span> <span class="mf">.</span> <span class="s1">'/phpdocumentor/reflection-docblock/src'</span><span class="p">),</span>
	<span class="mf">...</span><span class="p">);</span>
</pre></table></code></div></div><p>PSR4标准的初始化接口：</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

	<span class="cd">/**
     * Registers a set of PSR-4 directories for a given namespace,
     * replacing any others previously set for this namespace.
     *
     * @param string       $prefix The prefix/namespace, with trailing '\\'
     * @param array|string $paths  The PSR-4 base directories
     *
     * @throws \InvalidArgumentException
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">setPsr4</span><span class="p">(</span><span class="nv">$prefix</span><span class="p">,</span> <span class="nv">$paths</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$prefix</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">fallbackDirsPsr4</span> <span class="o">=</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span> <span class="nv">$paths</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$length</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$prefix</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">'\\'</span> <span class="o">!==</span> <span class="nv">$prefix</span><span class="p">[</span><span class="nv">$length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="err">\</span><span class="nf">InvalidArgumentException</span><span class="p">(</span><span class="s2">"A non-empty PSR-4 prefix must end with a namespace separator."</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">prefixLengthsPsr4</span><span class="p">[</span><span class="nv">$prefix</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="nv">$prefix</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$length</span><span class="p">;</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">prefixDirsPsr4</span><span class="p">[</span><span class="nv">$prefix</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span> <span class="nv">$paths</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>PSR4初始化接口也很简单，转换后的结构同 autoload_static.php 的 $prefixLengthsPsr4 和 $prefixDirsPsr4 。如果没有顶级命名空间，就只存储一个路径名，以便在后面尝试加载。</p><p><strong>命名空间直接映射</strong></p><p>autoload_classmap.php</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="c1">// autoload_classmap.php @generated by Composer</span>

<span class="nv">$vendorDir</span> <span class="o">=</span> <span class="nb">dirname</span><span class="p">(</span><span class="nb">dirname</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">));</span>
<span class="nv">$baseDir</span> <span class="o">=</span> <span class="nb">dirname</span><span class="p">(</span><span class="nv">$vendorDir</span><span class="p">);</span>

<span class="k">return</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'App\\Console\\Kernel'</span> <span class="o">=&gt;</span> <span class="nv">$baseDir</span> <span class="mf">.</span> <span class="s1">'/app/Console/Kernel.php'</span><span class="p">,</span>
    <span class="s1">'App\\Exceptions\\Handler'</span> <span class="o">=&gt;</span> <span class="nv">$baseDir</span> <span class="mf">.</span> <span class="s1">'/app/Exceptions/Handler.php'</span><span class="p">,</span>
    <span class="s1">'App\\Http\\Controllers\\Controller'</span> <span class="o">=&gt;</span> <span class="nv">$baseDir</span> <span class="mf">.</span> <span class="s1">'/app/Http/Controllers/Controller.php'</span><span class="p">,</span>
	<span class="mf">...</span><span class="p">);</span>
</pre></table></code></div></div><p>addClassMap：</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

	<span class="cd">/**
     * @param array $classMap Class to filename map
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">addClassMap</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$classMap</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">classMap</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">classMap</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">classMap</span><span class="p">,</span> <span class="nv">$classMap</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">classMap</span> <span class="o">=</span> <span class="nv">$classMap</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>这个最简单，就是整个命名空间与目录之间的映射。</p><p><strong>5）注册自动加载核心类对象</strong></p><p>讲完了 Composer 自动加载功能的启动与初始化，经过启动与初始化，自动加载核心类对象已经获得了顶级命名空间与相应目录的映射，也就是说，如果有命名空间 ‘App\Console\Kernel’，我们已经可以找到它对应的类文件所在位置。那么，它是什么时候被触发去找的呢？这就是 composer 自动加载的核心了。</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="nv">$loader</span><span class="o">-&gt;</span><span class="nf">register</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</pre></table></code></div></div><p>\Composer\Autoload\ClassLoader::register具体实现：</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

     <span class="cd">/**
     * Registers this instance as an autoloader.
     *
     * @param bool $prepend Whether to prepend the autoloader or not
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">register</span><span class="p">(</span><span class="nv">$prepend</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span>
    <span class="p">{</span>
    	<span class="c1">// 注册自动加载函数</span>
        <span class="nb">spl_autoload_register</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'loadClass'</span><span class="p">),</span> <span class="kc">true</span><span class="p">,</span> <span class="nv">$prepend</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">===</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">vendorDir</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//no-op</span>
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$prepend</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">::</span><span class="nv">$registeredLoaders</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">vendorDir</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="p">)</span> <span class="o">+</span> <span class="k">self</span><span class="o">::</span><span class="nv">$registeredLoaders</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nb">unset</span><span class="p">(</span><span class="k">self</span><span class="o">::</span><span class="nv">$registeredLoaders</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">vendorDir</span><span class="p">]);</span>
            <span class="k">self</span><span class="o">::</span><span class="nv">$registeredLoaders</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">vendorDir</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>因$prepend为true，spl_autoload_register() 会添加自动加载核心类ClassLoader的loadClass()函数到队列之首，而不是队列尾部，该函数会最先执行。这个函数负责按照PSR标准将顶层命名空间以下的内容转为对应的目录，核心类ClassLoader将loadClass()函数注册到PHP SPL中的spl_autoload_register()里面去。这样，每当PHP遇到一个不认识的命名空间的时候，PHP会自动调用注册到spl_autoload_register里面的函数队列，运行其中的每个函数，直到找到命名空间对应的文件。</p><p><strong>6）自动加载全局函数</strong></p><p>Composer不止可以自动加载命名空间，还可以加载全局函数。怎么实现的呢？很简单，把全局函数写到特定的文件里面去，在程序运行前挨个require就行了。</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$useStaticLoader</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$includeFiles</span> <span class="o">=</span> <span class="nc">Composer\Autoload\ComposerStaticInit59119be9e78c643dbb9f5087be96e6d6</span><span class="o">::</span><span class="nv">$files</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$includeFiles</span> <span class="o">=</span> <span class="k">require</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/autoload_files.php'</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$includeFiles</span> <span class="k">as</span> <span class="nv">$fileIdentifier</span> <span class="o">=&gt;</span> <span class="nv">$file</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">composerRequire59119be9e78c643dbb9f5087be96e6d6</span><span class="p">(</span><span class="nv">$fileIdentifier</span><span class="p">,</span> <span class="nv">$file</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>跟核心类的初始化一样，全局函数自动加载也分为两种：静态初始化和普通初始化，静态加载只支持PHP5.6以上并且不支持HHVM。</p><p><strong>a. 静态初始化 ( PHP &gt;= 5.6 ，并且不支持 HHVM 虚拟机)</strong></p><p>\Composer\Autoload\ComposerStaticInit59119be9e78c643dbb9f5087be96e6d6::$files</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="c1">// autoload_static.php @generated by Composer</span>

<span class="kn">namespace</span> <span class="nn">Composer\Autoload</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">ComposerStaticInit59119be9e78c643dbb9f5087be96e6d6</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="nv">$files</span> <span class="o">=</span> <span class="k">array</span> <span class="p">(</span>
        <span class="s1">'a4a119a56e50fbb293281d9a48007e0e'</span> <span class="o">=&gt;</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/..'</span> <span class="mf">.</span> <span class="s1">'/symfony/polyfill-php80/bootstrap.php'</span><span class="p">,</span>
        <span class="s1">'6e3fae29631ef280660b3cdad06f25a8'</span> <span class="o">=&gt;</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/..'</span> <span class="mf">.</span> <span class="s1">'/symfony/deprecation-contracts/function.php'</span><span class="p">,</span>
        <span class="s1">'0e6d7bf4a5811bfa5cf40c5ccd6fae6a'</span> <span class="o">=&gt;</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/..'</span> <span class="mf">.</span> <span class="s1">'/symfony/polyfill-mbstring/bootstrap.php'</span><span class="p">,</span>
    <span class="mf">...</span><span class="p">);</span>
</pre></table></code></div></div><p><strong>b. 普通初始化</strong></p><p>autoload_files.php</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="c1">// autoload_files.php @generated by Composer</span>

<span class="nv">$vendorDir</span> <span class="o">=</span> <span class="nb">dirname</span><span class="p">(</span><span class="nb">dirname</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">));</span>
<span class="nv">$baseDir</span> <span class="o">=</span> <span class="nb">dirname</span><span class="p">(</span><span class="nv">$vendorDir</span><span class="p">);</span>

<span class="k">return</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'a4a119a56e50fbb293281d9a48007e0e'</span> <span class="o">=&gt;</span> <span class="nv">$vendorDir</span> <span class="mf">.</span> <span class="s1">'/symfony/polyfill-php80/bootstrap.php'</span><span class="p">,</span>
    <span class="s1">'6e3fae29631ef280660b3cdad06f25a8'</span> <span class="o">=&gt;</span> <span class="nv">$vendorDir</span> <span class="mf">.</span> <span class="s1">'/symfony/deprecation-contracts/function.php'</span><span class="p">,</span>
    <span class="s1">'0e6d7bf4a5811bfa5cf40c5ccd6fae6a'</span> <span class="o">=&gt;</span> <span class="nv">$vendorDir</span> <span class="mf">.</span> <span class="s1">'/symfony/polyfill-mbstring/bootstrap.php'</span><span class="p">,</span>
    <span class="mf">...</span><span class="p">);</span>
</pre></table></code></div></div><p>同静态初始化。</p><p><strong>c. 加载全局函数</strong></p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">ComposerAutoloaderInit59119be9e78c643dbb9f5087be96e6d6</span> <span class="p">{</span>
  <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">getLoader</span><span class="p">(){</span>
      <span class="mf">...</span>
      <span class="k">foreach</span> <span class="p">(</span><span class="nv">$includeFiles</span> <span class="k">as</span> <span class="nv">$fileIdentifier</span> <span class="o">=&gt;</span> <span class="nv">$file</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">composerRequire59119be9e78c643dbb9f5087be96e6d6</span><span class="p">(</span><span class="nv">$fileIdentifier</span><span class="p">,</span> <span class="nv">$file</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="mf">...</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">function</span> <span class="n">composerRequire59119be9e78c643dbb9f5087be96e6d6</span><span class="p">(</span><span class="nv">$fileIdentifier</span><span class="p">,</span> <span class="nv">$file</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">'__composer_autoload_files'</span><span class="p">][</span><span class="nv">$fileIdentifier</span><span class="p">]))</span> <span class="p">{</span>
        <span class="k">require</span> <span class="nv">$file</span><span class="p">;</span>

        <span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">'__composer_autoload_files'</span><span class="p">][</span><span class="nv">$fileIdentifier</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>这一段很有讲究，可以发掘出两个问题：</p><p><strong>1）第一个问题：</strong>为什么自动加载引导类的getLoader()函数不直接require $includeFiles里面的每个文件名，而要用类外面的函数composerRequire59119be9e78c643dbb9f5087be96e6d6？（顺便说下这个函数名hash仍然为了避免和用户定义函数冲突）</p><p><strong>因为怕有人在全局函数所在的文件写$this或者self。</strong>假如$includeFiles有个app/helper.php文件，这个helper.php文件的函数外有一行代码：$this-&gt;foo()，如果引导类在getLoader()函数直接require($file)，那么引导类就会运行这句代码，调用自己的foo()函数，这显然是错的。事实上helper.php就不应该出现$this或self这样的代码，这样写一般都是用户写错了的，一旦这样的事情发生：</p><ul><li>第一种情况：引导类恰好有foo()函数，那么就会莫名其妙执行了引导类的foo();<li>第二种情况：引导类没有foo()函数，但是却甩出来引导类没有foo()方法这样的错误提示，用户不知道自己哪里错了。</ul><p>把require语句放到引导类的外面，遇到$this或者self，程序就会告诉用户根本没有类，$this或self无效，错误信息更加明朗。</p><p><strong>2）第二个问题：</strong>为什么要用hash作为$fileIdentifier，上面的代码明显可以看出来这个变量是用来控制全局函数只被require一次的，那为什么不用require_once呢？</p><p><strong>事实上require_once比require效率低很多，使用全局变量$GLOBALS这样控制加载会更快</strong>。</p></blockquote><p><strong>7）自动加载的运行</strong></p><p>\Composer\Autoload\ClassLoader::loadClass的具体实现：</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

     <span class="cd">/**
     * Loads the given class or interface.
     *
     * @param  string    $class The name of the class
     * @return bool|null True if loaded, null otherwise
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">loadClass</span><span class="p">(</span><span class="nv">$class</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$file</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">findFile</span><span class="p">(</span><span class="nv">$class</span><span class="p">))</span> <span class="p">{</span>
            <span class="nf">includeFile</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>

            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

	<span class="cd">/**
     * Finds the path to the file where the class is defined.
     *
     * @param string $class The name of the class
     *
     * @return string|false The path if found, false otherwise
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">findFile</span><span class="p">(</span><span class="nv">$class</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// class map lookup</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">classMap</span><span class="p">[</span><span class="nv">$class</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">classMap</span><span class="p">[</span><span class="nv">$class</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">classMapAuthoritative</span> <span class="o">||</span> <span class="k">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">missingClasses</span><span class="p">[</span><span class="nv">$class</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">!==</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">apcuPrefix</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$file</span> <span class="o">=</span> <span class="nb">apcu_fetch</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">apcuPrefix</span><span class="mf">.</span><span class="nv">$class</span><span class="p">,</span> <span class="nv">$hit</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$hit</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nv">$file</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">findFileWithExtension</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="s1">'.php'</span><span class="p">);</span>

        <span class="c1">// Search for Hack files if we are running on HHVM</span>
        <span class="k">if</span> <span class="p">(</span><span class="kc">false</span> <span class="o">===</span> <span class="nv">$file</span> <span class="o">&amp;&amp;</span> <span class="nb">defined</span><span class="p">(</span><span class="s1">'HHVM_VERSION'</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">findFileWithExtension</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="s1">'.hh'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">!==</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">apcuPrefix</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">apcu_add</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">apcuPrefix</span><span class="mf">.</span><span class="nv">$class</span><span class="p">,</span> <span class="nv">$file</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="kc">false</span> <span class="o">===</span> <span class="nv">$file</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Remember that this class does not exist.</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">missingClasses</span><span class="p">[</span><span class="nv">$class</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$file</span><span class="p">;</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>loadClass()函数主要调用findFile()函数加载文件路径，findFile()在解析命名空间的时候主要分为两部分：classMap和findFileWithExtension()函数。classMap很简单，直接看命名空间是否在映射数组中即可；麻烦的是findFileWithExtension()函数，这个函数包含了PSR0和PSR4标准的实现。</p><blockquote><p>说明：</p><ul><li>查找路径成功后执行的includeFile()函数仍然是类外面的函数，并不是ClassLoader的成员函数，原理跟上面一样，防止有用户写$this或self；<li>如果命名空间是以\开头的，要去掉\然后再匹配。</ul></blockquote><p>\Composer\Autoload\ClassLoader::findFileWithExtension的具体实现：</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

    <span class="k">private</span> <span class="k">function</span> <span class="n">findFileWithExtension</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="nv">$ext</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// PSR-4 lookup</span>
        <span class="nv">$logicalPathPsr4</span> <span class="o">=</span> <span class="nb">strtr</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="s1">'\\'</span><span class="p">,</span> <span class="no">DIRECTORY_SEPARATOR</span><span class="p">)</span> <span class="mf">.</span> <span class="nv">$ext</span><span class="p">;</span>

        <span class="nv">$first</span> <span class="o">=</span> <span class="nv">$class</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">prefixLengthsPsr4</span><span class="p">[</span><span class="nv">$first</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nv">$subPath</span> <span class="o">=</span> <span class="nv">$class</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span><span class="kc">false</span> <span class="o">!==</span> <span class="nv">$lastPos</span> <span class="o">=</span> <span class="nb">strrpos</span><span class="p">(</span><span class="nv">$subPath</span><span class="p">,</span> <span class="s1">'\\'</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$subPath</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$subPath</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$lastPos</span><span class="p">);</span>
                <span class="nv">$search</span> <span class="o">=</span> <span class="nv">$subPath</span> <span class="mf">.</span> <span class="s1">'\\'</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">prefixDirsPsr4</span><span class="p">[</span><span class="nv">$search</span><span class="p">]))</span> <span class="p">{</span>
                    <span class="nv">$pathEnd</span> <span class="o">=</span> <span class="no">DIRECTORY_SEPARATOR</span> <span class="mf">.</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$logicalPathPsr4</span><span class="p">,</span> <span class="nv">$lastPos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">prefixDirsPsr4</span><span class="p">[</span><span class="nv">$search</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$dir</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$file</span> <span class="o">=</span> <span class="nv">$dir</span> <span class="mf">.</span> <span class="nv">$pathEnd</span><span class="p">))</span> <span class="p">{</span>
                            <span class="k">return</span> <span class="nv">$file</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// PSR-4 fallback dirs</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">fallbackDirsPsr4</span> <span class="k">as</span> <span class="nv">$dir</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$file</span> <span class="o">=</span> <span class="nv">$dir</span> <span class="mf">.</span> <span class="no">DIRECTORY_SEPARATOR</span> <span class="mf">.</span> <span class="nv">$logicalPathPsr4</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nv">$file</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// PSR-0 lookup</span>
        <span class="k">if</span> <span class="p">(</span><span class="kc">false</span> <span class="o">!==</span> <span class="nv">$pos</span> <span class="o">=</span> <span class="nb">strrpos</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="s1">'\\'</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// namespaced class name</span>
            <span class="nv">$logicalPathPsr0</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$logicalPathPsr4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="mf">.</span> <span class="nb">strtr</span><span class="p">(</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$logicalPathPsr4</span><span class="p">,</span> <span class="nv">$pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">'_'</span><span class="p">,</span> <span class="no">DIRECTORY_SEPARATOR</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// PEAR-like class name</span>
            <span class="nv">$logicalPathPsr0</span> <span class="o">=</span> <span class="nb">strtr</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="s1">'_'</span><span class="p">,</span> <span class="no">DIRECTORY_SEPARATOR</span><span class="p">)</span> <span class="mf">.</span> <span class="nv">$ext</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">prefixesPsr0</span><span class="p">[</span><span class="nv">$first</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">prefixesPsr0</span><span class="p">[</span><span class="nv">$first</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$prefix</span> <span class="o">=&gt;</span> <span class="nv">$dirs</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">===</span> <span class="nb">strpos</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="nv">$prefix</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$dirs</span> <span class="k">as</span> <span class="nv">$dir</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$file</span> <span class="o">=</span> <span class="nv">$dir</span> <span class="mf">.</span> <span class="no">DIRECTORY_SEPARATOR</span> <span class="mf">.</span> <span class="nv">$logicalPathPsr0</span><span class="p">))</span> <span class="p">{</span>
                            <span class="k">return</span> <span class="nv">$file</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// PSR-0 fallback dirs</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">fallbackDirsPsr0</span> <span class="k">as</span> <span class="nv">$dir</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$file</span> <span class="o">=</span> <span class="nv">$dir</span> <span class="mf">.</span> <span class="no">DIRECTORY_SEPARATOR</span> <span class="mf">.</span> <span class="nv">$logicalPathPsr0</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nv">$file</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// PSR-0 include paths.</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">useIncludePath</span> <span class="o">&amp;&amp;</span> <span class="nv">$file</span> <span class="o">=</span> <span class="nb">stream_resolve_include_path</span><span class="p">(</span><span class="nv">$logicalPathPsr0</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$file</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
</pre></table></code></div></div><h3 id="4-laravel自动加载">4. Laravel自动加载</h3><p>除了库的下载，Composer 还准备了一个自动加载文件，它可以加载 Composer 下载的库中所有的类文件。使用它，你只需要将下面这行代码添加到你项目的引导文件中：</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">require</span> <span class="s1">'vendor/autoload.php'</span><span class="p">;</span>
</pre></table></code></div></div><p>Laravel框架在其入口文件 public/index.php 中引入了composer的自动加载文件，从而达到Laravel的自动加载：</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="cd">/**
 * Laravel - A PHP Framework For Web Artisans
 *
 * @package  Laravel
 * @author   Taylor Otwell &lt;taylor@laravel.com&gt;
 */</span>

<span class="nb">define</span><span class="p">(</span><span class="s1">'LARAVEL_START'</span><span class="p">,</span> <span class="nb">microtime</span><span class="p">(</span><span class="kc">true</span><span class="p">));</span>

<span class="cm">/*
|--------------------------------------------------------------------------
| Register The Auto Loader
|--------------------------------------------------------------------------
|
| Composer provides a convenient, automatically generated class loader for
| our application. We just need to utilize it! We'll simply require it
| into the script here so that we don't have to worry about manual
| loading any of our classes later on. It feels great to relax.
|
*/</span>

<span class="c1">// 引入composer的自动加载文件</span>
<span class="k">require</span> <span class="k">__DIR__</span><span class="mf">.</span><span class="s1">'/../vendor/autoload.php'</span><span class="p">;</span>

<span class="c1">// 省略...</span>
</pre></table></code></div></div><h3 id="5-参考目录">5. 参考目录</h3><ul><li><p>PHP的类自动加载机制：https://blog.csdn.net/hguisu/article/details/7463333</p><li><p>深入解析 composer 的自动加载原理：https://segmentfault.com/a/1190000014948542</p><li><p>composer官方文档： https://docs.phpcomposer.com/00-intro.html</p></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%8A%80%E6%9C%AF/'>计算机技术</a>, <a href='/categories/php/'>php</a>, <a href='/categories/laravel%E6%A1%86%E6%9E%B6/'>laravel框架</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/php/" class="post-tag no-text-decoration" >php</a> <a href="/tags/laravel/" class="post-tag no-text-decoration" >laravel</a> <a href="/tags/autoload/" class="post-tag no-text-decoration" >autoload</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 该博客文章由作者通过 <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> 进行授权。</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Laravel的类自动加载机制 - 格物致知&url=https://ccke.github.io/posts/laravel's_autoload_mechanism/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Laravel的类自动加载机制 - 格物致知&u=https://ccke.github.io/posts/laravel's_autoload_mechanism/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Laravel的类自动加载机制 - 格物致知&url=https://ccke.github.io/posts/laravel's_autoload_mechanism/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>最近更新</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/short_circuit_algorithms/">图的5种常用的最短路算法</a><li><a href="/posts/laravel's_autoload_mechanism/">Laravel的类自动加载机制</a><li><a href="/posts/sort_algorithm/">go语言版十大排序算法</a></ul></div><div id="access-tags"> <span>热门标签</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/php/">php</a> <a class="post-tag" href="/tags/%E7%AE%97%E6%B3%95/">算法</a> <a class="post-tag" href="/tags/%E7%AE%A1%E7%90%86/">管理</a> <a class="post-tag" href="/tags/autoload/">autoload</a> <a class="post-tag" href="/tags/go/">go</a> <a class="post-tag" href="/tags/laravel/">laravel</a> <a class="post-tag" href="/tags/%E4%B8%AA%E4%BA%BA%E7%AE%A1%E7%90%86/">个人管理</a> <a class="post-tag" href="/tags/%E5%95%86%E4%B8%9A/">商业</a> <a class="post-tag" href="/tags/%E5%9B%BE/">图</a> <a class="post-tag" href="/tags/%E5%BF%83%E7%90%86%E5%AD%A6/">心理学</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">文章目录</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>接下来阅读</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/short_circuit_algorithms/"><div class="card-body"> <span class="timeago small" > Mar 21 <i class="unloaded">2021-03-21T21:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>图的5种常用的最短路算法</h3><div class="text-muted small"><p> 1. 简介 图的5种常用的最短路算法为：朴素Dijkstra、 堆优化Dijkstra、Bellman-Ford、SPFA、 Floyd。 以下为这5种算法的应用场景以及时间复杂度： 多源汇最短路（任意两点间的最短路） Floyd O(n^3) 单源最短路 无负边权（所有边长都为正数） ...</p></div></div></a></div><div class="card"> <a href="/posts/sort_algorithm/"><div class="card-body"> <span class="timeago small" > May 30 <i class="unloaded">2021-05-30T22:55:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>go语言版十大排序算法</h3><div class="text-muted small"><p> 1. 前言 排序算法是最经典的算法知识，目前共有十种排序算法：冒泡排序、选择排序、插入排序、归并排序、快速排序、希尔排序、堆排序、计数排序、桶排序、基数排序。 最近刚好在学习go语言，因此想着用go语言实现这些排序算法，纯当练练手，顺便回顾下排序算法~ 2. 算法实现 2.1 冒泡排序 算法思想： 算法过程： 在未排序序列中比较相邻的元素，如果第一个比第二个小/大，...</p></div></div></a></div><div class="card"> <a href="/posts/thoughts_on_Reading_Effective_Managers/"><div class="card-body"> <span class="timeago small" > Nov 28 <i class="unloaded">2021-11-28T22:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>《卓有成效的管理者》读后感</h3><div class="text-muted small"><p> 1. 前言 对组织负有责任，能影响组织经营成果的人，就是管理者。管理者，就必须卓有成效。卓有成效是可以学会的！ 2. 卓有成效的管理者大纲</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/short_circuit_algorithms/" class="btn btn-outline-primary" prompt="上一篇"><p>图的5种常用的最短路算法</p></a> <a href="/posts/sort_algorithm/" class="btn btn-outline-primary" prompt="下一篇"><p>go语言版十大排序算法</p></a></div><div class="utterances-container"> <script src="https://utteranc.es/client.js" repo="ccke/ccke.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async> </script></div><script type="text/javascript"> $(function() { window.onmessage = evt => { if (evt.origin === 'https://utteranc.es') { toggle.updateCommentStyle(); window.onmessage = null; } } }); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/chukeey3">chukeey</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，否则本网站上的博客文章均由作者根据知识共享许可协议 - 署名标示 4.0（CC BY 4.0）进行授权许可。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本博客由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，使用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 作为主题</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">热门标签</h4><a class="post-tag" href="/tags/php/">php</a> <a class="post-tag" href="/tags/%E7%AE%97%E6%B3%95/">算法</a> <a class="post-tag" href="/tags/%E7%AE%A1%E7%90%86/">管理</a> <a class="post-tag" href="/tags/autoload/">autoload</a> <a class="post-tag" href="/tags/go/">go</a> <a class="post-tag" href="/tags/laravel/">laravel</a> <a class="post-tag" href="/tags/%E4%B8%AA%E4%BA%BA%E7%AE%A1%E7%90%86/">个人管理</a> <a class="post-tag" href="/tags/%E5%95%86%E4%B8%9A/">商业</a> <a class="post-tag" href="/tags/%E5%9B%BE/">图</a> <a class="post-tag" href="/tags/%E5%BF%83%E7%90%86%E5%AD%A6/">心理学</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://ccke.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
